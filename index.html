<!DOCTYPE html>
<html lang="en" id="top">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Running Late Dynasty</title>
  <meta name="description" content="Running Late Dynasty — splash with ticker, quick links, and auto-redirect to the newest issue." />
  <meta name="color-scheme" content="dark" />

  <!-- Canonical -->
  <link rel="canonical" href="https://professorzoom45.github.io/PTG/">

  <!-- Social / OG -->
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Perfect Timing Gaming">
  <meta property="og:title" content="Running Late Dynasty — D1SN">
  <meta property="og:description" content="Live ticker with Top-5, recent user-vs-user results, and quick links to the latest issue.">
  <meta property="og:url" content="https://professorzoom45.github.io/PTG/">
  <meta property="og:image" content="https://professorzoom45.github.io/PTG/Oh.PNG">
  <meta property="og:image:secure_url" content="https://professorzoom45.github.io/PTG/Oh.PNG">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="theme-color" content="#d5b15b">

  <!-- Icons / PWA -->
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="assets/favicon.ico" sizes="any">
  <link rel="apple-touch-icon" href="assets/apple-touch-icon.PNG">
  <link rel="manifest" href="assets/site.webmanifest">

  <!-- Fonts (sporty display for headings) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton&display=swap" rel="stylesheet">

  <!-- Warm next pages -->
  <link rel="prefetch" href="issue03.html" as="document" />
  <link rel="prefetch" href="issue04.html" as="document" />
  <link rel="prefetch" href="teamhub.html" as="document" />
  <link rel="prefetch" href="coaches.html" as="document" />
  <link rel="prefetch" href="confbatt.html" as="document" />
  <link rel="prefetch" href="boost.html" as="document" />
  <link rel="prefetch" href="polls.html" as="document" />
  <link rel="prefetch" href="standings.html" as="document" />
  <link rel="preload" as="image" href="Oh.PNG" />

  <style>
    :root{
      --bg:#0b0b0b;--card:#141414;--line:#232323;--text:#e6e6e6;--muted:#a6a6a6;
      --gold:#d5b15b;--accent:#f2d675;
      --chip:#121212;--chip-b:#2a2a2a;
      --btn-a:#1a1a1a;--btn-b:#262626;--btn-glow:#f2d67566
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--gold);text-decoration:none}
    a:focus-visible,.cta-btn:focus-visible,.stay-btn:focus-visible{outline:2px solid var(--accent);outline-offset:2px;border-radius:10px}

    h1,h2{font-family:"Anton",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; letter-spacing:.4px}

    /* Ticker */
    .ticker{position:sticky;top:0;z-index:999;background:linear-gradient(90deg,#121212,#181818);border-bottom:1px solid #1f1f1f}
    .ticker .wrap{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px;padding:10px 14px}
    .logo-a{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:linear-gradient(180deg,#f7e8a5,#d6b458 60%,#a3832c);color:#111;font-weight:900;letter-spacing:.6px;border:1px solid #caae51;box-shadow:0 0 0 2px #3c3210 inset, 0 2px 10px #0008;white-space:nowrap}
    .track{overflow:hidden;flex:1}
    .row{display:inline-flex;gap:28px;align-items:center;white-space:nowrap;animation:marquee 28s linear infinite}
    .row>*{font-weight:900;letter-spacing:.3px;position:relative;padding-right:36px;margin-right:36px}
    .row>*::after{content:"";position:absolute;right:8px;top:50%;transform:translateY(-50%);width:6px;height:24px;background:linear-gradient(180deg,#f7e8a5,#d6b458 60%,#a3832c);border-radius:3px}
    .ticker:hover .row{animation-play-state:paused}
    @keyframes marquee{from{transform:translateX(0)} to{transform:translateX(-50%)}}
    @media (prefers-reduced-motion:reduce){ .row{animation:none !important} }

    /* Splash */
    .splash{min-height:66vh;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;color:var(--accent);position:relative;padding:18px 14px}
    /* Vignette + subtle film grain */
    .splash::before{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:radial-gradient(120% 80% at 50% 40%, transparent 55%, rgba(0,0,0,.35) 100%);
      mix-blend-mode:multiply;
    }
    .splash::after{
      content:""; position:absolute; inset:0; pointer-events:none; opacity:.06;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/></filter><rect width='100%' height='100%' filter='url(%23n)'/></svg>");
      background-size:300px 300px; background-repeat:repeat;
    }

    .splash h1{margin:0 0 8px;font-size:clamp(1.8rem,5vw,3rem)}
    .splash-hero{width:min(100%,1100px);max-width:92vw;height:auto;margin:.75rem auto;border-radius:16px;border:1px solid #2a2a2a;box-shadow:0 10px 40px #000a}
    .note{max-width:1100px;margin:8px auto 0;color:var(--muted)}
    .cta-rows{display:grid;gap:10px;margin-top:10px}
    .row-btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .cta-btn{border:1px solid #3c3c3c;padding:10px 14px;border-radius:12px;color:#fff;background:linear-gradient(180deg,var(--btn-a),var(--btn-b));box-shadow:0 0 0 2px #000 inset, 0 0 18px var(--btn-glow);font-weight:800;letter-spacing:.2px;position:relative;overflow:hidden}
    .cta-btn.primary{box-shadow:0 0 0 2px #000 inset, 0 0 26px var(--btn-glow)}
    .cta-btn.primary::after{
      content:""; position:absolute; left:12px; right:12px; bottom:8px; height:2px;
      background:linear-gradient(90deg,transparent, var(--gold), transparent);
      transform:scaleX(0); transform-origin:center; transition:transform .28s ease;
      border-radius:2px;
    }
    .cta-btn.primary:hover::after,
    .cta-btn.primary:focus-visible::after{ transform:scaleX(1); }

    .stay-btn{border:1px solid var(--chip-b);background:#101010;border-radius:12px;padding:10px 14px;color:#eaeaea;font-weight:800}
    .count{font-variant-numeric:tabular-nums}

    /* Footer */
    footer{max-width:1100px;margin:24px auto 40px;padding:0 14px;color:#bdbdbd;font-size:.95rem;display:grid;gap:8px;text-align:center}
    footer .links{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
    footer a{color:var(--accent)}
  </style>
</head>
<body>

  <!-- Ticker (auto-built from polls.html arrays) -->
  <div class="ticker" role="region" aria-label="D1SN headlines">
    <div class="wrap">
      <a href="#top" class="logo-a" title="Home">D1SN</a>
      <div class="track" aria-live="polite">
        <div class="row" id="tickerRow">
          <span>Loading ticker…</span>
          <span aria-hidden="true">Loading ticker…</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Splash -->
  <section class="splash" aria-label="cover">
    <h1>Running Late Dynasty</h1>

    <a href="Oh.PNG" target="_blank" title="Open cover (Oh.PNG)">
      <img class="splash-hero" src="Oh.PNG" alt="Running Late hero cover" width="1600" height="900" fetchpriority="high" />
    </a>

    <p class="note">
      Auto-redirecting to <strong>latest issue</strong> in <span id="count" class="count" aria-live="polite">9</span>s…
    </p>

    <!-- Buttons (organized) -->
    <div class="cta-rows" role="navigation" aria-label="Quick Links">
      <!-- Row 1: Latest (alone) -->
      <div class="row-btns">
        <a class="cta-btn primary" id="readNow" href="issue01.html" title="Open Latest Issue (detected)">Open Latest Issue</a>
      </div>

      <!-- Row 2: Polls + Standings -->
      <div class="row-btns">
        <a class="cta-btn" href="polls.html" title="Polls & Power Index">Polls & Power Index</a>
        <a class="cta-btn" href="standings.html" title="Standings">Standings</a>
      </div>

      <!-- Row 3: Directories / Events / Tools -->
      <div class="row-btns">
        <a class="cta-btn" href="teamhub.html" title="Browse Team Pages">Team Pages</a>
        <a class="cta-btn" href="coaches.html" title="Schools Page">Schools</a>
        <a class="cta-btn" href="confbatt.html" title="Conference Battle">Conference Battle</a>
        <a class="cta-btn" href="boost.html" title="Dynasty Boost Tracker">Dynasty Boost</a>
      </div>

      <!-- Row 4: Past Issues (auto-filled, above Stay Here) -->
      <div class="row-btns" id="issuesRow" aria-label="Past Issues"></div>

      <!-- Row 5: Stay Here (alone) -->
      <div class="row-btns">
        <button class="stay-btn" id="stayBtn" type="button" title="Stay on the splash page">Stay Here</button>
      </div>
    </div>
  </section>

  <!-- Compact footer -->
  <footer>
    <div>© D1SN — Running Late Dynasty</div>
    <div class="links">
      <a href="polls.html" title="See rankings and the user-only Power Index">About D1SN</a> •
      <a href="mailto:changethewrldplz@gmail.com" title="Email D1SN">Contact</a> •
      <a href="https://discord.gg/8GfXM4EWVX" target="_blank" rel="noopener" title="Join the league on Discord">How to join</a>
    </div>
  </footer>

  <script>
    // ---------- Settings ----------
    const STAY_KEY = 'rl_splash_stay';
    const DEFAULT_LATEST = 'issue01.html';
    const MAX_ISSUE_SCAN = 99;

    // ---------- Latest issue detection (contiguous scan) ----------
    async function detectLatestIssue(){
      let lastOk = null;
      for(let i = 1; i <= MAX_ISSUE_SCAN; i++){
        const n = String(i).padStart(2,'0');
        const href = `issue${n}.html`;
        try{
          const res = await fetch(href + '?chk=' + Date.now(), {cache:'no-store'});
          if(res.ok) lastOk = href; else break;
        }catch(_e){ break; }
      }
      return lastOk || DEFAULT_LATEST;
    }

    function renderIssuesRow(latestHref){
      const row = document.getElementById('issuesRow');
      if(!row) return;
      const latestNum = +latestHref.match(/issue(\d+)\.html/i)[1];
      let html = '';
      for(let i = 1; i <= latestNum; i++){
        const n = String(i).padStart(2,'0');
        const href = `issue${n}.html`;
        html += `<a class="cta-btn" href="${href}" title="Open Issue ${n}">Issue ${n}</a>`;
      }
      row.innerHTML = html;
    }

    let LATEST_HREF = DEFAULT_LATEST;
    (async () => {
      LATEST_HREF = await detectLatestIssue();
      const readNow = document.getElementById('readNow');
      if(readNow) readNow.href = LATEST_HREF;
      renderIssuesRow(LATEST_HREF);
    })();

    // ---------- Countdown ----------
    (function countdown(){
      const qs = new URLSearchParams(location.search);
      const tParam = parseInt(qs.get('t') || '', 10);
      let t = Number.isFinite(tParam) ? Math.max(0, tParam) : 9;
      if (qs.get('stay') === '1') localStorage.setItem(STAY_KEY, '1');

      const stayed  = localStorage.getItem(STAY_KEY) === '1';
      const countEl = document.getElementById('count');
      const stayBtn = document.getElementById('stayBtn');
      const readNow = document.getElementById('readNow');

      let canceled = stayed;
      if (stayed) countEl.textContent = '—';

      stayBtn.addEventListener('click', () => {
        canceled = true;
        localStorage.setItem(STAY_KEY, '1');
        countEl.textContent = '—';
      });
      readNow.addEventListener('click', () => { canceled = true; });

      const tick = () => {
        if (canceled) return;
        countEl.textContent = t;
        if (t <= 0) location.href = LATEST_HREF || DEFAULT_LATEST;
        else { t -= 1; setTimeout(tick, 1000); }
      };
      if (!canceled) setTimeout(tick, 1000);
    })();

    // ---------- Robust constant extractor from polls.html ----------
    // Slices a balanced [...] array literal starting at the index of '['
    function sliceBalancedArray(source, startIdx){
      let i = startIdx, depth = 0;
      for(; i < source.length; i++){
        const ch = source[i];
        if(ch === '[') depth++;
        else if(ch === ']'){
          depth--;
          if(depth === 0) return source.slice(startIdx, i+1);
        }
      }
      return null;
    }
    // Find "const NAME = [ ... ];" and return the literal string "[ ... ]"
    function extractArrayLiteral(name, html){
      const re = new RegExp(`const\\s+${name}\\s*=\\s*\\[`, 'm');
      const m = re.exec(html);
      if(!m) return null;
      const start = m.index + m[0].length - 1; // at the '['
      return sliceBalancedArray(html, start);
    }
    // ACTIVE_USERS is "const ACTIVE_USERS = new Set([ ... ]);"
    function extractActiveUsers(html){
      const re = /const\\s+ACTIVE_USERS\\s*=\\s*new\\s+Set\\s*\\(\\s*\\[/m;
      const m = re.exec(html);
      if(!m) return [];
      const start = m.index + m[0].length - 1; // at '['
      const arrLit = sliceBalancedArray(html, start);
      if(!arrLit) return [];
      try { return Function('return ' + arrLit)(); } catch { return []; }
    }
    // Safe-ish parser for array/object literals from the page (no code paths)
    function parseArrayLiteral(lit){
      try { return Function('return ' + lit)(); } catch { return []; }
    }

    // ---------- Build combined poll + recent UvU from polls.html ----------
    async function buildTicker(){
      const row = document.getElementById('tickerRow');

      const fallback = [
        'Top-5 loading…',
        'Recent UvU loading…'
      ];
      const render = (items)=> {
        const mirror = items.concat(items.map(x=>x));
        row.innerHTML = mirror.map((t,i)=>`<span${i>=items.length?' aria-hidden="true"':''}>${t}</span>`).join('');
      };

      try{
        const res = await fetch('polls.html', {cache:'no-store'});
        if(!res.ok) throw new Error('polls fetch failed');
        const html = await res.text();

        // Extract needed arrays
        const MEDIA_POLL = parseArrayLiteral(extractArrayLiteral('MEDIA_POLL', html) || '[]');
        const COACHES_POLL = parseArrayLiteral(extractArrayLiteral('COACHES_POLL', html) || '[]');
        const WEEK5 = parseArrayLiteral(extractArrayLiteral('WEEK5_RESULTS', html) || '[]');
        const WEEK6 = parseArrayLiteral(extractArrayLiteral('WEEK6_RESULTS', html) || '[]');
        const ACTIVE_USERS = new Set(extractActiveUsers(html));

        // Compute Combined (avg rank; NR=26)
        const mMap = new Map(MEDIA_POLL.map(([rk,t,pts]) => [t, {rk, pts:pts??0}]));
        const cMap = new Map(COACHES_POLL.map(([rk,t,pts]) => [t, {rk, pts:pts??0}]));
        const teams = new Set([...mMap.keys(), ...cMap.keys()]);
        const combined = [...teams].map(t=>{
          const mr = mMap.get(t)?.rk ?? 26, cr = cMap.get(t)?.rk ?? 26;
          const mp = mMap.get(t)?.pts ?? 0,  cp = cMap.get(t)?.pts ?? 0;
          const avg = (mr + cr) / 2;
          return {team:t, avg, media:mr, coaches:cr, points:(mp+cp)};
        }).sort((a,b)=> a.avg-b.avg || b.points-a.points)
          .map((x,i)=>({rank:i+1, team:x.team}));

        // Top-5
        const top5Span = `Top-5 (Combined): ${combined.slice(0,5).map(r=>`#${r.rank} ${r.team}`).join(' • ')}`;

        // Rank lookup for prettified game lines
        const rankMap = new Map(combined.map(r => [r.team, r.rank]));
        const rk = t => {
          const r = rankMap.get(t);
          return (r && r<=25) ? `#${r} ${t}` : t;
        };

        // User vs User filter
        const isUvU = g => ACTIVE_USERS.has(g.away) && ACTIVE_USERS.has(g.home);

        const w6UvU = WEEK6.filter(isUvU).map(g=>({wk:6, ...g}));
        const w5UvU = WEEK5.filter(isUvU).map(g=>({wk:5, ...g}));
        const recent = [...w6UvU, ...w5UvU];

        const fmt = g => `W${g.wk}: ${rk(g.away)} ${g.a}–${g.h} at ${rk(g.home)}`;
        const uvuSpan = recent.length
          ? `Recent UvU: ${recent.slice(0,4).map(fmt).join(' • ')}`
          : 'Recent UvU: (none logged in W6/W5)';

        render([top5Span, uvuSpan, 'See: Polls & Power Index →']);
      }catch(err){
        render(fallback);
      }
    }
    buildTicker();

    // ---------- Hero image fallback ----------
    (function heroFallback(){
      const hero = document.querySelector('.splash-hero');
      if(!hero) return;
      hero.addEventListener('error', ()=>{
        const note = document.createElement('div');
        note.className = 'note';
        note.textContent = '(Hero image unavailable — expected Oh.PNG in the repo root)';
        hero.replaceWith(note);
      });
    })();
  </script>
</body>
  </html>
